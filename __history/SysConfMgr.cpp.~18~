//---------------------------------------------------------------------------

#pragma hdrstop

#include "SysConfMgr.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)

extern void SetGeneralCaption(TCHAR* s);

TSysConfMgr::TSysConfMgr()
{
   IniCurPath();
}

TSysConfMgr::~TSysConfMgr()
{

}

void TSysConfMgr::SelCurSysName(void)
{

	TCHAR tdir [1024];
	::GetCurrentDirectoryW(1024, tdir);

	curDir = tdir;

	wcscat(tdir, L"\\GorizontLab.gcf");

	ini = new TIniFile(tdir);

	//curSysName = L"GorizontLab";

	curSysName = ini->ReadString("GENERAL","CONFNAME", L"GorizontLab");

}

void TSysConfMgr::IniCurPath(void)
{
	SelCurSysName();
	
	//TCHAR tdir [1024];
	//::GetCurrentDirectoryW(1024, tdir);

	//curDir = tdir;

	curConfPath = curDir + L"\\" + L"Conf"  L"\\";
	::CreateDirectoryW(curConfPath.c_bstr(), 0);

	confFold = curConfPath;

	curConfPath = curConfPath + curSysName + L".xml";

	curBasePath =  curDir + L"\\" + L"Base"  L"\\";
	::CreateDirectoryW(curBasePath.c_bstr(), 0);

	baseFold = curBasePath;

	curBasePath = curBasePath + curSysName + L"\\";

	//Sleep(1);
}

void TSysConfMgr::SetXMLDoc(TXMLDocument* doc)
{
   xmlDoc = doc;
}

TXMLDocument* TSysConfMgr::GetXMLDoc(void)
{
   return xmlDoc;
}

TCHAR* TSysConfMgr::GetXMLDocPath(void)
{
   return  curConfPath.c_bstr();
}

void TSysConfMgr::SaveCurSysName(void)
{
	ini->WriteString("GENERAL","CONFNAME", curSysName);
}

int TSysConfMgr::CreateConf(TSaveDialog* dlg)
{
	 wchar_t fres[1024];
	 wchar_t cres[1024];

	 dlg->InitialDir = confFold;
	 dlg->Filter = L"*.xml|*.xml";
	 dlg->FileName = L"NewSystemGL";
	 dlg->Title = L"Cоздать новую систему";
	 if (dlg->Execute()!=IDOK) return -1;

	 wcscpy(fres, (wchar_t*)dlg->FileName.c_str());
	 wcscpy(cres, (wchar_t*)dlg->FileName.c_str());

	 int i = 0;

	 for (i = wcslen(cres); i >=0 ; i--) {

		if (cres[i] == '\\') break;
	 }

	 TCHAR cnew [1024];
	 wcscpy(cnew, &cres[i+1]);

	 i = 0;

	 for (i = wcslen(cnew); i >=0 ; i--) {

		if (cnew[i] == '.')
		{
			cnew[i] = 0;
			break;
		}
	 }

	 AcceptConf(cnew);

	 return 0;
}

int TSysConfMgr::OpenConf(TOpenDialog* dlg)
{

	 WideString fres(L"");

	 dlg->InitialDir = confFold;
	 dlg->Filter = L"*.xml|*.xml";
	 dlg->FileName = curSysName;

	 dlg->Title = L"Открыть конфигурацию";
	 if (dlg->Execute()!=IDOK) return -1;

	 fres = dlg->FileName;

	 TCHAR cres[1024];
	 wcscpy(cres,fres.c_bstr());

	 int i = 0;

	 for (i = wcslen(cres); i >=0 ; i--) {

		if (cres[i] == '\\') break;
	 }

	 TCHAR cnew [1024];
	 wcscpy(cnew, &cres[i+1]);

	 i = 0;

	 for (i = wcslen(cnew); i >=0 ; i--) {

		if (cnew[i] == '.')
		{
			cnew[i] = '\0';
			break;
		}
	 }

	 AcceptConf(cnew);


   return 0;
}

int TSysConfMgr::AcceptConf(TCHAR* newconf)
{
   curSysName = newconf;
   SaveCurSysName();
   IniCurPath();

   return 0;
}

int TSysConfMgr::SaveConf(TSaveDialog* dlg)
{

	 WideString fres(L"");
	 int i = 0;

	 dlg->InitialDir = confFold;
	 dlg->Filter = L"*.xml|*.xml";

	 dlg->FileName = L"NewSystemGL";

	 dlg->Title = L"Сохранить конфигурацию как ...";
	 if (dlg->Execute()!=IDOK) return -1;

	 fres = dlg->FileName;
	 TCHAR cftmp[1024];

	 wcscpy(cftmp,fres.c_bstr());

	 for (i = wcslen(cftmp); i>=0; i--)
	 {
		 if (cftmp[i] == '.')
		 {
			 cftmp[i] = '\0';
			 break;
		 }
	 }

	 wcscat(cftmp,L".ini");

	 FILE* ftmp = NULL;

	 ftmp = _wfopen(cftmp,L"rb");

	 if (ftmp != NULL) {

		fclose(ftmp);
		Application->MessageBoxW(L"Данная конфигурация уже существует!",L"ВНИМАНИЕ!",0);
		return -1;
	 }


	 TCHAR cres[1024];

	 wcscpy(cres,fres.c_bstr());

	 for (i = wcslen(cres); i >=0 ; i--) {

		if (cres[i] == '\\') break;
	 }

	 TCHAR cnew [1024];
	 wcscpy(cnew, &cres[i+1]);

	 i = 0;

	 for (i = wcslen(cnew); i >=0 ; i--) {

		if (cnew[i] == '.')
		{
			cnew[i] = '\0';
			break;
		}
	 }


	 TCHAR cmd[1024];

	 wcscpy (cmd, L"copy \"");

	 wcscat(cmd,curConfPath.c_bstr());

	 wcscat(cmd,L"\" ");

	 TCHAR cpar[1024];
	 wcscpy(cpar,L"\"");
	 wcscat(cpar,curConfPath.c_bstr());

	 for (i = wcslen(cpar); i >=0 ; i--) {

		if (cpar[i] == '\\')
		{
			cpar[i+1] = '\0';
			break;
		}
	 }

	 wcscat(cpar,cnew);
	 wcscat(cpar,L".ini");
	 wcscat(cmd,cpar);
	 wcscat(cmd,L"\"");

	 system((char*)cmd);


	 wcscpy (cmd, L"xcopy /s /i \"");

	 wcscat(cmd, curBasePath.c_bstr());

	 cmd[wcslen(cmd)-1] = '\0';

	 wcscat (cmd,L"\" ");

	 wcscpy(cpar,L"\"");
	 wcscat(cpar,curBasePath.c_bstr());

	 for (i = wcslen(cpar)-1; i >=0 ; i--) {

		if (cpar[i] == '\\')
		{
			cpar[i+1] = '\0';
			break;
		}
	 }

	 wcscat(cpar,cnew);
	 wcscat(cpar,L"\"");
	 wcscat(cmd,cpar);

	 system((char*)cmd);

	 AcceptConf(cnew);

	return 0;
}
