//---------------------------------------------------------------------------

#pragma hdrstop

#include "SysConfMgr.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)

extern void SetGeneralCaption(TCHAR* s);

TSysConfMgr::TSysConfMgr()
{
   IniCurPath();
}

TSysConfMgr::~TSysConfMgr()
{

}

void TSysConfMgr::SelCurSysName(void)
{

	TCHAR tdir [1024];
	::GetCurrentDirectoryW(1024, tdir);

	curDir = tdir;

	wcscat(tdir, L"\\GorizontLab.gcf");

	ini = new TIniFile(tdir);

	//curSysName = L"GorizontLab";

	curSysName = ini->ReadString("GENERAL","CONFNAME", L"GorizontLab");

}

void TSysConfMgr::IniCurPath(void)
{
	SelCurSysName();
	
	//TCHAR tdir [1024];
	//::GetCurrentDirectoryW(1024, tdir);

	//curDir = tdir;

	curConfPath = curDir + L"\\" + L"Conf"  L"\\";
	::CreateDirectoryW(curConfPath.c_bstr(), 0);

	confFold = curConfPath;

	curConfPath = curConfPath + curSysName + L".xml";

	curBasePath =  curDir + L"\\" + L"Base"  L"\\";
	::CreateDirectoryW(curBasePath.c_bstr(), 0);

	baseFold = curBasePath;

	curBasePath = curBasePath + curSysName + L"\\";

	//Sleep(1);
}

void TSysConfMgr::SetXMLDoc(TXMLDocument* doc)
{
   xmlDoc = doc;
}

TXMLDocument* TSysConfMgr::GetXMLDoc(void)
{
   return xmlDoc;
}

TCHAR* TSysConfMgr::GetXMLDocPath(void)
{
   return  curConfPath.c_bstr();
}

void TSysConfMgr::SaveCurSysName(void)
{
	ini->WriteString("GENERAL","CONFNAME", curSysName);
}

int TSysConfMgr::CreateConf(TSaveDialog* dlg)
{
	 wchar_t fres[1024];
	 wchar_t cres[1024];

	 dlg->InitialDir = confFold;
	 dlg->Filter = L"*.xml|*.xml";
	 dlg->FileName = L"NewSystemGL";
	 dlg->Title = L"Cоздать новую систему";
	 if (dlg->Execute()!=IDOK) return -1;

	 wcscpy(fres, (wchar_t*)dlg->FileName.c_str());
	 wcscpy(cres, (wchar_t*)dlg->FileName.c_str());

	 int i = 0;

	 for (i = wcslen(cres); i >=0 ; i--) {

		if (cres[i] == '\\') break;
	 }

	 TCHAR cnew [1024];
	 wcscpy(cnew, &cres[i+1]);

	 i = 0;

	 for (i = wcslen(cnew); i >=0 ; i--) {

		if (cnew[i] == '.')
		{
			cnew[i] = 0;
			break;
		}
	 }

	 AcceptConf(cnew);

	 return 0;
}

int TSysConfMgr::OpenConf(TOpenDialog* dlg)
{

	 WideString fres(L"");

	 dlg->InitialDir = confFold;
	 dlg->Filter = L"*.xml|*.xml";
	 dlg->FileName = curSysName;

	 dlg->Title = L"Открыть конфигурацию";
	 if (dlg->Execute()!=IDOK) return -1;

	 fres = dlg->FileName;

	 TCHAR cres[1024];
	 wcscpy(cres,fres.c_bstr());

	 int i = 0;

	 for (i = wcslen(cres); i >=0 ; i--) {

		if (cres[i] == '\\') break;
	 }

	 TCHAR cnew [1024];
	 wcscpy(cnew, &cres[i+1]);

	 i = 0;

	 for (i = wcslen(cnew); i >=0 ; i--) {

		if (cnew[i] == '.')
		{
			cnew[i] = '\0';
			break;
		}
	 }

	 AcceptConf(cnew);


   return 0;
}

int TSysConfMgr::AcceptConf(TCHAR* newconf)
{
   curSysName = newconf;
   SaveCurSysName();
   IniCurPath();

   return 0;
}

int TSysConfMgr::SaveConf(TSaveDialog* dlg)
{

}
